// Generated by purs version 0.11.6
"use strict";
var Control_Applicative = require("../Control.Applicative");
var Control_Apply = require("../Control.Apply");
var Control_Bind = require("../Control.Bind");
var Control_Monad_Aff = require("../Control.Monad.Aff");
var Control_Monad_Aff_AVar = require("../Control.Monad.Aff.AVar");
var Control_Monad_Aff_Console = require("../Control.Monad.Aff.Console");
var Control_Monad_Eff = require("../Control.Monad.Eff");
var Control_Monad_Eff_Exception = require("../Control.Monad.Eff.Exception");
var Control_Monad_Error_Class = require("../Control.Monad.Error.Class");
var Control_Monad_Except = require("../Control.Monad.Except");
var Control_Monad_Free = require("../Control.Monad.Free");
var Control_Monad_State_Class = require("../Control.Monad.State.Class");
var Control_Monad_State_Trans = require("../Control.Monad.State.Trans");
var Control_Monad_Trans_Class = require("../Control.Monad.Trans.Class");
var Control_Semigroupoid = require("../Control.Semigroupoid");
var Data_Either = require("../Data.Either");
var Data_Exists = require("../Data.Exists");
var Data_Foldable = require("../Data.Foldable");
var Data_Foreign = require("../Data.Foreign");
var Data_Foreign_JSON = require("../Data.Foreign.JSON");
var Data_Function = require("../Data.Function");
var Data_Functor = require("../Data.Functor");
var Data_List_Types = require("../Data.List.Types");
var Data_NaturalTransformation = require("../Data.NaturalTransformation");
var Data_Newtype = require("../Data.Newtype");
var Data_Show = require("../Data.Show");
var Data_StrMap = require("../Data.StrMap");
var Data_Tuple = require("../Data.Tuple");
var Global_Unsafe = require("../Global.Unsafe");
var Prelude = require("../Prelude");
var Presto_Core_Language_Runtime_API = require("../Presto.Core.Language.Runtime.API");
var Presto_Core_LocalStorage = require("../Presto.Core.LocalStorage");
var Presto_Core_Types_App = require("../Presto.Core.Types.App");
var Presto_Core_Types_Language_Flow = require("../Presto.Core.Types.Language.Flow");
var Presto_Core_Types_Language_Interaction = require("../Presto.Core.Types.Language.Interaction");
var Presto_Core_Types_Language_Storage = require("../Presto.Core.Types.Language.Storage");
var Presto_Core_Types_Permission = require("../Presto.Core.Types.Permission");
var PermissionRunner = (function () {
    function PermissionRunner(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    PermissionRunner.create = function (value0) {
        return function (value1) {
            return new PermissionRunner(value0, value1);
        };
    };
    return PermissionRunner;
})();
var Runtime = (function () {
    function Runtime(value0, value1, value2) {
        this.value0 = value0;
        this.value1 = value1;
        this.value2 = value2;
    };
    Runtime.create = function (value0) {
        return function (value1) {
            return function (value2) {
                return new Runtime(value0, value1, value2);
            };
        };
    };
    return Runtime;
})();
var updateState = function (key) {
    return function (value) {
        return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_State_Class.get(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Aff.monadAff)))(function (v) {
            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff_AVar.takeVar(v)))(function (v1) {
                var st$prime = Data_StrMap.insert(key)(value)(v1);
                return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff_AVar.putVar(v)(st$prime));
            });
        });
    };
};
var runErrorHandler = function (v) {
    if (v instanceof Presto_Core_Types_Language_Flow.ThrowError) {
        return Control_Monad_Error_Class.throwError(Control_Monad_State_Trans.monadThrowStateT(Control_Monad_Aff.monadThrowAff))(Control_Monad_Eff_Exception.error(v.value0));
    };
    if (v instanceof Presto_Core_Types_Language_Flow.ReturnResult) {
        return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v.value0);
    };
    throw new Error("Failed pattern match at Presto.Core.Language.Runtime.Interpreter line 83, column 1 - line 83, column 71: " + [ v.constructor.name ]);
};
var readState = Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_State_Class.get(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Aff.monadAff)))(function ($91) {
    return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff_AVar.peekVar($91));
});
var interpretUI = function (uiRunner) {
    return function (v) {
        return Control_Bind.bind(Control_Monad_Aff.bindAff)(uiRunner(Global_Unsafe.unsafeStringify(v.value0)))(function (v1) {
            var v2 = Control_Monad_Except.runExcept(Data_Foreign_JSON.parseJSON(v1));
            if (v2 instanceof Data_Either.Right) {
                return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(v.value1(v2.value0));
            };
            if (v2 instanceof Data_Either.Left) {
                return Control_Monad_Error_Class.throwError(Control_Monad_Aff.monadThrowAff)(Control_Monad_Eff_Exception.error(Data_Show.show(Data_List_Types.showNonEmptyList(Data_Foreign.showForeignError))(v2.value0)));
            };
            throw new Error("Failed pattern match at Presto.Core.Language.Runtime.Interpreter line 67, column 3 - line 69, column 46: " + [ v2.constructor.name ]);
        });
    };
};
var runUIInteraction = function (uiRunner) {
    return Control_Monad_Free.foldFree(Control_Monad_Aff.monadRecAff)(interpretUI(uiRunner));
};
var run = function (runtime) {
    return Control_Monad_Free.foldFree(Control_Monad_State_Trans.monadRecStateT(Control_Monad_Aff.monadRecAff))(function (v) {
        return Data_Exists.runExists(interpret(runtime))(v);
    });
};
var interpret = function (v) {
    return function (v1) {
        if (v1 instanceof Presto_Core_Types_Language_Flow.CallAPI) {
            return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Bind.bind(Control_Monad_Aff.bindAff)(Presto_Core_Language_Runtime_API.runAPIInteraction(v.value2)(v1.value0))(function ($92) {
                return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(v1.value1($92));
            }));
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.RunUI) {
            return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Bind.bind(Control_Monad_Aff.bindAff)(runUIInteraction(v.value0)(v1.value0))(function ($93) {
                return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(v1.value1($93));
            }));
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.ForkUI) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Data_Functor["void"](Control_Monad_State_Trans.functorStateT(Control_Monad_Aff.functorAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff.forkAff(runUIInteraction(v.value0)(v1.value0)))))(function () {
                return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value1);
            });
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.Get && v1.value0 instanceof Presto_Core_Types_Language_Flow.LocalStore) {
            return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Bind.bind(Control_Monad_Aff.bindAff)(Presto_Core_LocalStorage.getValueFromLocalStore(v1.value1))(function ($94) {
                return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(v1.value2($94));
            }));
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.Get && v1.value0 instanceof Presto_Core_Types_Language_Flow.InMemoryStore) {
            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(readState)(function ($95) {
                return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value2(Data_StrMap.lookup(v1.value1)($95)));
            });
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow["Set"] && v1.value0 instanceof Presto_Core_Types_Language_Flow.LocalStore) {
            return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Presto_Core_LocalStorage.setValueToLocalStore(v1.value1)(v1.value2)))(function () {
                return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value3);
            });
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow["Set"] && v1.value0 instanceof Presto_Core_Types_Language_Flow.InMemoryStore) {
            return Control_Apply.applySecond(Control_Monad_State_Trans.applyStateT(Control_Monad_Aff.monadAff))(updateState(v1.value1)(v1.value2))(Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value3));
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.Fork) {
            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(forkFlow(v)(v1.value0))(function ($96) {
                return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value1($96));
            });
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.DoAff) {
            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(v1.value0))(function ($97) {
                return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value1($97));
            });
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.Await) {
            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff_AVar.peekVar(v1.value0)))(function ($98) {
                return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value1($98));
            });
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.Delay) {
            return Control_Apply.applySecond(Control_Monad_State_Trans.applyStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff.delay(v1.value0)))(Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value1));
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.OneOf) {
            var parFlow = function (st) {
                return function (flow) {
                    return Control_Monad_Aff.ParAff(Control_Monad_State_Trans.runStateT(run(v)(flow))(st));
                };
            };
            return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff_Console.warn("oneOf does not work yet")))(function () {
                return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_State_Class.get(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Aff.monadAff)))(function (v2) {
                    return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Data_Newtype.unwrap(Control_Monad_Aff.newtypeParAff)(Data_Foldable.oneOf(Data_Foldable.foldableArray)(Control_Monad_Aff.plusParAff)(Data_Functor.map(Data_Functor.functorArray)(parFlow(v2))(v1.value0)))))(function (v3) {
                        return Control_Bind.discard(Control_Bind.discardUnit)(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_State_Class.put(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Aff.monadAff))(v3.value1))(function () {
                            return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value1(v3.value0));
                        });
                    });
                });
            });
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.HandleError) {
            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(run(v)(v1.value0))(runErrorHandler))(function ($99) {
                return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1.value1($99));
            });
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.CheckPermissions) {
            return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Bind.bind(Control_Monad_Aff.bindAff)(v.value1.value0(v1.value0))(function ($100) {
                return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(v1.value1($100));
            }));
        };
        if (v1 instanceof Presto_Core_Types_Language_Flow.TakePermissions) {
            return Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Bind.bind(Control_Monad_Aff.bindAff)(v.value1.value1(v1.value0))(function ($101) {
                return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(v1.value1($101));
            }));
        };
        throw new Error("Failed pattern match at Presto.Core.Language.Runtime.Interpreter line 87, column 1 - line 87, column 95: " + [ v.constructor.name, v1.constructor.name ]);
    };
};
var forkFlow = function (rt) {
    return function (flow) {
        return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_State_Class.get(Control_Monad_State_Trans.monadStateStateT(Control_Monad_Aff.monadAff)))(function (v) {
            return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff_AVar.makeVar))(function (v1) {
                var m = Control_Monad_State_Trans.evalStateT(Control_Monad_Aff.functorAff)(run(rt)(flow))(v);
                return Control_Bind.bind(Control_Monad_State_Trans.bindStateT(Control_Monad_Aff.monadAff))(Control_Monad_Trans_Class.lift(Control_Monad_State_Trans.monadTransStateT)(Control_Monad_Aff.monadAff)(Control_Monad_Aff.forkAff(Control_Bind.bind(Control_Monad_Aff.bindAff)(m)(Control_Monad_Aff_AVar.putVar(v1)))))(function (v2) {
                    return Control_Applicative.pure(Control_Monad_State_Trans.applicativeStateT(Control_Monad_Aff.monadAff))(v1);
                });
            });
        });
    };
};
module.exports = {
    PermissionRunner: PermissionRunner, 
    Runtime: Runtime, 
    run: run
};
