// Generated by purs version 0.11.6
"use strict";
var $foreign = require("./foreign");
var Control_Applicative = require("../Control.Applicative");
var Control_Bind = require("../Control.Bind");
var Control_Monad_Aff = require("../Control.Monad.Aff");
var Control_Monad_Eff = require("../Control.Monad.Eff");
var Control_Monad_Eff_Exception = require("../Control.Monad.Eff.Exception");
var Control_Monad_Error_Class = require("../Control.Monad.Error.Class");
var Control_Monad_Except = require("../Control.Monad.Except");
var Control_Monad_Free = require("../Control.Monad.Free");
var Control_Monad_Loops = require("../Control.Monad.Loops");
var Control_Semigroupoid = require("../Control.Semigroupoid");
var Data_Array = require("../Data.Array");
var Data_Either = require("../Data.Either");
var Data_Eq = require("../Data.Eq");
var Data_Foldable = require("../Data.Foldable");
var Data_Foreign = require("../Data.Foreign");
var Data_Foreign_Class = require("../Data.Foreign.Class");
var Data_Foreign_Generic = require("../Data.Foreign.Generic");
var Data_Function = require("../Data.Function");
var Data_Function_Uncurried = require("../Data.Function.Uncurried");
var Data_Functor = require("../Data.Functor");
var Data_HeytingAlgebra = require("../Data.HeytingAlgebra");
var Data_List = require("../Data.List");
var Data_List_Types = require("../Data.List.Types");
var Data_Show = require("../Data.Show");
var Data_Tuple = require("../Data.Tuple");
var Prelude = require("../Prelude");
var Presto_Core_Types_App = require("../Presto.Core.Types.App");
var Presto_Core_Types_Language_Flow = require("../Presto.Core.Types.Language.Flow");
var Presto_Core_Types_Permission = require("../Presto.Core.Types.Permission");
var toAndroidPermission = function (v) {
    if (v instanceof Presto_Core_Types_Permission.PermissionSendSms) {
        return "android.permission.READ_SMS";
    };
    if (v instanceof Presto_Core_Types_Permission.PermissionReadPhoneState) {
        return "android.permission.READ_PHONE_STATE";
    };
    if (v instanceof Presto_Core_Types_Permission.PermissionWriteStorage) {
        return "android.permission.WRITE_EXTERNAL_STORAGE";
    };
    if (v instanceof Presto_Core_Types_Permission.PermissionReadStorage) {
        return "android.permission.READ_EXTERNAL_STORAGE";
    };
    throw new Error("Failed pattern match at Engineering.OS.Permission line 27, column 1 - line 27, column 44: " + [ v.constructor.name ]);
};
var storagePermissionGranted = Control_Bind.bind(Control_Monad_Free.freeBind)(Presto_Core_Types_Language_Flow.checkPermissions([ Presto_Core_Types_Permission.PermissionWriteStorage.value ]))(function (v) {
    if (v instanceof Presto_Core_Types_Permission.PermissionGranted) {
        return Control_Applicative.pure(Control_Monad_Free.freeApplicative)(true);
    };
    return Control_Applicative.pure(Control_Monad_Free.freeApplicative)(false);
});
var requestPermissions = function (permissions) {
    var toResponse = function (wasGranted) {
        if (wasGranted) {
            return Presto_Core_Types_Permission.PermissionGranted.value;
        };
        return Presto_Core_Types_Permission.PermissionDeclined.value;
    };
    var jPermission = Data_Functor.map(Data_Functor.functorArray)(toAndroidPermission)(permissions);
    return Control_Bind.bind(Control_Monad_Aff.bindAff)(Control_Monad_Aff.makeAff(function (err) {
        return function (sc) {
            return $foreign["requestPermission'"](err, sc, Data_Show.show(Data_Show.showArray(Data_Show.showString))(jPermission));
        };
    }))(function (v) {
        var v1 = Control_Monad_Except.runExcept(Data_Foreign_Generic.decodeJSON(Data_Foreign_Class.arrayDecode(Data_Foreign_Class.booleanDecode))(v));
        if (v1 instanceof Data_Either.Right) {
            return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(Data_Array.zip(permissions)(Data_Functor.map(Data_Functor.functorArray)(toResponse)(v1.value0)));
        };
        if (v1 instanceof Data_Either.Left) {
            return Control_Monad_Error_Class.throwError(Control_Monad_Aff.monadThrowAff)(Control_Monad_Eff_Exception.error(Data_Show.show(Data_List_Types.showNonEmptyList(Data_Foreign.showForeignError))(v1.value0)));
        };
        throw new Error("Failed pattern match at Engineering.OS.Permission line 73, column 3 - line 75, column 46: " + [ v1.constructor.name ]);
    });
};
var getPermissionStatus = function (permission) {
    return Control_Bind.bind(Control_Monad_Aff.bindAff)(Control_Monad_Aff.makeAff(function (err) {
        return function (sc) {
            return $foreign["getPermissionStatus'"](err, sc, toAndroidPermission(permission));
        };
    }))(function (v) {
        var v1 = Control_Monad_Except.runExcept(Data_Foreign_Generic.decodeJSON(Data_Foreign_Class.booleanDecode)(v));
        if (v1 instanceof Data_Either.Right) {
            return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(v1.value0);
        };
        if (v1 instanceof Data_Either.Left) {
            return Control_Monad_Error_Class.throwError(Control_Monad_Aff.monadThrowAff)(Control_Monad_Eff_Exception.error(Data_Show.show(Data_List_Types.showNonEmptyList(Data_Foreign.showForeignError))(v1.value0)));
        };
        throw new Error("Failed pattern match at Engineering.OS.Permission line 59, column 3 - line 61, column 46: " + [ v1.constructor.name ]);
    });
};
var checkIfPermissionsGranted = function (permissions) {
    return Control_Bind.bind(Control_Monad_Aff.bindAff)(Control_Monad_Loops.allM(Control_Monad_Aff.monadAff)(getPermissionStatus)(Data_List.fromFoldable(Data_Foldable.foldableArray)(permissions)))(function (v) {
        return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)((function () {
            if (v) {
                return Presto_Core_Types_Permission.PermissionGranted.value;
            };
            return Presto_Core_Types_Permission.PermissionDeclined.value;
        })());
    });
};
var allPermissionGranted = Data_Foldable.all(Data_Foldable.foldableArray)(Data_HeytingAlgebra.heytingAlgebraBoolean)(function (v) {
    return Data_Eq.eq(Presto_Core_Types_Permission.eqPermissionStatus)(v.value1)(Presto_Core_Types_Permission.PermissionGranted.value);
});
var getStoragePermission = (function () {
    var storageGranted = Control_Bind.bind(Control_Monad_Free.freeBind)(Presto_Core_Types_Language_Flow.checkPermissions([ Presto_Core_Types_Permission.PermissionWriteStorage.value ]))(function (v) {
        if (v instanceof Presto_Core_Types_Permission.PermissionGranted) {
            return Control_Applicative.pure(Control_Monad_Free.freeApplicative)(true);
        };
        return Control_Applicative.pure(Control_Monad_Free.freeApplicative)(false);
    });
    var askForStorage = Control_Bind.bindFlipped(Control_Monad_Free.freeBind)(function ($28) {
        return Control_Applicative.pure(Control_Monad_Free.freeApplicative)(allPermissionGranted($28));
    })(Presto_Core_Types_Language_Flow.takePermissions([ Presto_Core_Types_Permission.PermissionWriteStorage.value ]));
    return Control_Bind.ifM(Control_Monad_Free.freeBind)(storageGranted)(Control_Applicative.pure(Control_Monad_Free.freeApplicative)(true))(askForStorage);
})();
module.exports = {
    allPermissionGranted: allPermissionGranted, 
    checkIfPermissionsGranted: checkIfPermissionsGranted, 
    getPermissionStatus: getPermissionStatus, 
    getStoragePermission: getStoragePermission, 
    requestPermissions: requestPermissions, 
    storagePermissionGranted: storagePermissionGranted, 
    toAndroidPermission: toAndroidPermission, 
    "getPermissionStatus'": $foreign["getPermissionStatus'"], 
    "requestPermission'": $foreign["requestPermission'"]
};
